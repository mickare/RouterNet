<!DOCTYPE HTML>
<html>
<head>
  <title>Router Metric</title>
  <link href="logo.svg" rel="icon" type="image/svg+xml">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script src="d3.v3.js"></script>
  <script src="d3.byte.js"></script>
  <script src="rickshaw.js"></script>
  <script src="router.net.js"></script>
  <link type="text/css" rel="stylesheet" href="css/rickshaw.min.css">
  <link href="styles.css" rel="stylesheet" type="text/css">
</head>
<body>

  <div id="headerline">
    <div class="logo noselect defaultcursor">
      <div class="logoimage"><svg enable-background="new 0 0 512 512" version="1.1" viewBox="0 0 512 512" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><polygon points="371.599,459.216 331.563,362.738 291.527,459.216 207.426,459.216 160.721,285.249 113.957,459.216   0,459.216 0,398.9 67.734,398.9 160.721,52.784 252.725,395.396 331.563,205.471 411.885,398.9 512,398.9 512,459.216 "/></svg></div>
      <div class="logotext">Router Metric</div>
    </div>
    <div id="connection-status" class="connecting noselect defaultcursor">  
      <svg class="cloud-normal" version="1.1" viewBox="0 0 100 65" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><path d="M76.064,18.201c-1.379,0-2.729,0.119-4.043,0.34C68.74,7.816,58.578,0,46.543,0C31.854,0,19.947,11.641,19.947,26.002   c0,1.281,0.1,2.541,0.283,3.773c-0.705-0.08-1.418-0.135-2.145-0.135C8.098,29.641,0,37.557,0,47.32S8.098,65,18.086,65h57.979   C89.285,65,100,54.523,100,41.6C100,28.678,89.285,18.201,76.064,18.201z"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>  
      <svg class="cloud-thundercloud" version="1.1" viewBox="0 0 100 65" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M76.064,18.201c-1.379,0-2.729,0.119-4.043,0.34C68.74,7.816,58.578,0,46.543,0C31.854,0,19.947,11.641,19.947,26.002  c0,1.281,0.1,2.542,0.283,3.774c-0.705-0.081-1.418-0.135-2.145-0.135C8.098,29.641,0,37.557,0,47.32S8.098,65,18.086,65h57.979  C89.285,65,100,54.523,100,41.6C100,28.678,89.285,18.201,76.064,18.201z M56.859,39.757c-2.476,3.52-13.074,14.441-13.523,14.905  c-0.521,0.639-1.952,1.715-3.316,0.833c-0.393-0.253-0.857-0.766-0.857-1.773c0-0.966,0.439-1.95,0.49-2.06l5.166-11.433  c-0.972-0.389-2.637-1.062-3.93-1.623l-0.342-0.146c-1.309-0.556-2.939-1.246-2.939-3.042c0-0.858,0.408-1.856,1.246-3.046  c2.475-3.52,13.074-14.442,13.525-14.905c0.519-0.64,1.949-1.715,3.314-0.833c0.393,0.255,0.857,0.768,0.857,1.772  c0,0.967-0.439,1.951-0.49,2.061l-5.167,11.431c0.972,0.39,2.638,1.064,3.931,1.624l0.342,0.146  c1.309,0.555,2.939,1.247,2.939,3.044C58.105,37.57,57.697,38.566,56.859,39.757z"/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg>    
      <div class="label connecting">Connecting</div>
      <div class="label connected">Connected</div>
      <div class="label disconnected">Disconnected</div>  
    </div>  
  </div>
  
  <div id="metricBody">
    <div id="cpuMetric" data-label="CPU" class="noselect"></div>
    <div id="ramMetric" data-label="RAM" class="noselect"></div>

    <div id="packetMetric" data-label="Packets" class="noselect"></div>
    <div id="trafficMetric" data-label="Traffic" class="noselect"></div>
  </div>
  
<script>
  
  var colors = [
    '#1f77b4',  // muted blue
    '#ff7f0e',  // safety orange
    '#2ca02c',  // cooked asparagus green
    '#d62728',  // brick red
    '#9467bd',  // muted purple
    '#8c564b',  // chestnut brown
    '#e377c2',  // raspberry yogurt pink
    '#7f7f7f',  // middle gray
    '#bcbd22',  // curry yellow-green
    '#17becf'   // blue-teal
  ];
  
  class GraphMetric {
    constructor($container, seriesData, config, yscale) {
      var self = this;
      
      var label = $container.data("label");
    
      $container.addClass("metricBox");
      var $label = $("<div></div>").text(label).addClass("label");
      
      var $chartContainer = $("<div></div>").addClass("chartContainer");
      var $y_axis = $("<div></div>").addClass("y_axis");
      var $chart = $("<div></div>").addClass("chart");
      var $x_axis = $("<div></div>").addClass("x_axis");
      var $legend = false;
      if(config.legend) {
        $legend = $("<div></div>").addClass("legend");
      }
      $chartContainer.append($y_axis, $chart, $x_axis, $legend);
      $container.append($label, $chartContainer);
    
      var defaults = {
        width: $chart.width(),
        height: $chart.height(),
        renderer: 'line',
        stack: false,
        series: new Rickshaw.Series.FixedDuration(seriesData,
          undefined, {
          timeInterval: 1000,
          maxDataPoints: 100,
          timeBase: new Date().getTime()
        })
      };
      this.config = $.extend(true, {}, defaults, config, {element: $chart.get(0)});
      this.graph = new Rickshaw.Graph(this.config);
      
      this.axis_x = new Rickshaw.Graph.Axis.X({
        graph: this.graph,
        orientation: 'bottom',
        element: $x_axis.get(0),
        tickFormat: function(x) {
          var date = new Date(x);
          var m = date.getMinutes();
          var s = date.getSeconds();
          return (m<10 ? '0'+m : m) + ":" + (s<10 ? '0'+s : s);
        }    
      });

      if(yscale) {
        this.axis_y = new Rickshaw.Graph.Axis.Y.Scaled( {
          graph: this.graph,
          orientation: 'left',
          element: $y_axis.get(0),
          ticks: 4,
          scale: yscale
        } );
      } else {
        this.axis_y = new Rickshaw.Graph.Axis.Y( {
          graph: this.graph,
          orientation: 'left',
          element: $y_axis.get(0),         
          ticks: 4
        } );
      }
      
      if($legend) {
        this.legend = new Rickshaw.Graph.Legend( {
          element: $legend.get(0),
          graph: this.graph
        } );
        
        this.shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
          legend: this.legend,
          graph: this.graph
        } );
        
      }
      
      this.changed = true;      
      //this.render();
    }
    render() {
      this.changed = false;
      this.graph.render();
    }
    addData(data, x) {
      this.graph.series.addData(data, x);
      this.changed = true;
    }
    renderLazy() {
      if(this.changed) {
        this.render();
      }
    }
  }
  
  var graphs = {};
  
  function initGraphs() {  
    var linearscale = d3.scale.linear().nice();
    var bytescale = d3.byte.scale();

    graphs.cpu = new GraphMetric($("#cpuMetric"), [
                { name: 'load', renderer: 'area', color: "#9ED11F", className: "cpuload", color: colors[0] }
              ], {
                min:0,
                max:100, 
                renderer: 'area'
              }, 
              d3.scale.linear().nice());
    graphs.cpu.axis_y.tickFormat = function(y) { return y + "%"; };

    graphs.ram = new GraphMetric( $("#ramMetric"), [
                { name: 'allocatedMemory', renderer: 'area', color: colors[0] },
                { name: 'freeMemory', renderer: 'line', color: colors[1]},
                { name: 'maxMemory', renderer: 'line', color: colors[2] }
              ], {
                renderer: 'multi',
                min:0,
                legend: true
              }, bytescale);    
    graphs.ram.axis_y.tickFormat = function(y) {
      return Rickshaw.Fixtures.Number.formatBase1024KMGTP(y) + "B";
    };
      
    graphs.packet = new GraphMetric($("#packetMetric"), [
                { name: 'read', renderer: 'bar', color: colors[0] },
                { name: 'write', renderer: 'bar', color: colors[1] }
              ], {
                renderer: 'multi',
                min:0,
                interpolation: 'step-after',
                legend: true
              }, linearscale);
    graphs.packet.graph.gapSize = 0;

    graphs.traffic = new GraphMetric($("#trafficMetric"), [
                { name: 'writtenBytes', renderer: 'bar', color: colors[0] },
                { name: 'readBytes', renderer: 'bar', color: colors[1] },
                { name: 'writeThroughput', renderer: 'line', color: colors[2], disabled: true },
                { name: 'readThroughput', renderer: 'line', color: colors[3], disabled: true },
                { name: 'realWriteThroughput', renderer: 'line', color: colors[4], disabled: true }
              ], {
              gapSize: 0.2,
                renderer: 'multi',
                min:0,
                legend: true
              }, bytescale);
    graphs.traffic.axis_y.tickFormat = function(y) {
      return Rickshaw.Fixtures.Number.formatBase1024KMGTP(y) + "B";
    };
    
  }

  // *********************************************
  
  var trafficService = new Service("trafficMetric", {
    "trafficMetric": function(packet) {
      graphs.traffic.addData({
        writtenBytes: packet.lastWrittenBytes,
        readBytes: packet.lastReadBytes,
        writeThroughput: packet.lastWiteThroughput,
        readThroughput: packet.lastReadThroughput,
        realWriteThroughput: packet.realWriteThroughput        
      }, packet.timestamp);
    }
  });
  
  var cpuService = new Service("cpuMetric", {
    "cpuMetric": function(packet) {
      graphs.cpu.addData({
        load: packet.load
      }, packet.timestamp);
    }
  });
    
  var packetService = new Service("packetMetric", {
    "packetMetric": function(packet) {
      graphs.packet.addData({
        read: packet.read,
        write: packet.write
      }, packet.timestamp );
    }
  });
      
  var ramService = new Service("ramMetric", {
    "ramMetric": function(packet) {
      graphs.ram.addData({
        maxMemory: packet.maxMemory,
        allocatedMemory: packet.allocatedMemory,
        freeMemory: packet.allocatedMemory +packet.freeMemory
      }, packet.timestamp );
    }
  });
  
  // *********************************************
  // Protocol

  //NetProtocol.add("trafficMetric");
  //NetProtocol.add("cpuMetric");
  var protocolHandler = new ProtocolHandler(NetProtocol); 
  protocolHandler.registerAll(trafficService.handlers);
  protocolHandler.registerAll(cpuService.handlers);
  protocolHandler.registerAll(packetService.handlers);
  protocolHandler.registerAll(ramService.handlers);
  
  // *********************************************
  // Connection
  
  var conStatusClassMap = ["connecting", "connected", "disconnected", "disconnected"];
  function setConnectionStatus(status) {
    var $el = $("#connection-status");
    var activeClass = conStatusClassMap[status];
    conStatusClassMap.forEach(function(c) {
      $el.removeClass(c);     
    });    
    $el.addClass(activeClass);
  }
  
  var connection = new Connection('ws://localhost:5546/ws', protocolHandler);
  connection.onReadyStateChange = setConnectionStatus;
  var reconnectCounter = 0;
  connection.onOpen = function(evt, socket) {  
    trafficService.subscribe(this);
    cpuService.subscribe(this);
    packetService.subscribe(this);
    ramService.subscribe(this);
    
    /*
    setTimeout(function() {
      graphs.traffic.cleanUp();
      graphs.cpu.cleanUp();
      graphs.packet.cleanUp();
      graphs.ram.cleanUp();
    }, 1000);
    */
    
    reconnectCounter = 0;
  };
  connection.onClose = function(evt, socket) {
    reconnectCounter++;
    
    var timeout = (Math.log(reconnectCounter)/2+1)*1000;
    
    return;
    
    setTimeout(function(){
      connection.connect();
    }, timeout);
  };
  
  // *********************************************
    
  $(document).ready(function() {  
    initGraphs();
    connection.connect();
    setInterval(function() {
      Object.keys(graphs).forEach(function(k) {
        graphs[k].renderLazy();
      });
    }, 1000);
  });
</script>


</body>
</html>
