<!doctype html> 
<html>
<head>
  <title>Router Metric Test</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <link type="text/css" rel="stylesheet" href="css/rickshaw.min.css">
  <script src="d3.v3.js"></script>
  <script src="d3.byte.js"></script>
  <script src="rickshaw.js"></script>

  <style>
  
body {
        font-family: Arial, Helvetica, sans-serif;
        padding:0;
}

.div {
  overflow: show;
}
  
.metric_container {
        display: inline-block;
        position: relative;
        font-family: Arial, Helvetica, sans-serif;
        background-color: #EEE;
        padding:10px;
        padding-top:20px;
        width:670px;
        margin:5px;
}

.metric_container > .chart {
        display: inline-block;
        margin-left: 74px;
}
.metric_container > .y_axis {
        position: absolute;
        top: 20px;
        bottom: 0;
        width: 70px;
}
.metric_container > .x_axis {
        margin:0;
        margin-left: 74px;
        height:20px;
}

.metric_container > .label {
        width: 150px;
        height:30px;
        padding:2px;        
        position: absolute;
        top:75px;
        left:-48px;
        text-align: right;
        moz-transform: rotate(-90deg);
        -ms-transform: rotate(-90deg);
        -o-transform: rotate(-90deg);
        -webkit-transform: rotate(-90deg);

        transform: rotate(-90deg);
        text-transform: uppercase;
        color: #999;
}

#socket-status {
  display: inline-block;
  margin:5px;
  padding:3px;
  background-color:#DDD;
  float:right;
}

#socket-status.disconnected {
  color: red;
}
#socket-status.connected {
  color: green;
}
#socket-status::before {
  content: "Status: ";
}
#socket-status.disconnected::after {
  content: "disconnected";
}
#socket-status.connected::after {
  content: "connected";
}

</style>

  
  </head>
<body>

<div id="socket-status" class="disconnected"></div>

<div id="cpuMetric"></div>
<div id="ramMetric"></div>

<div id="packetMetric"></div>
<div id="trafficMetric"></div>

<script>

var GraphMetric = function($container, seriesData, label, scale) {

  var self = this;

  $container.addClass("metric_container");
  var $label = $("<div></div>").text(label).addClass("label");
  var $y_axis = $("<div></div>").addClass("y_axis");
  var $chart = $("<div></div>").addClass("chart");
  var $x_axis = $("<div></div>").addClass("x_axis");
  $container.append($label, $y_axis, $chart, $x_axis);
  
  this.graph = new Rickshaw.Graph( {
        element: $chart.get(0),
        width: 600,
        height: 250,
        renderer: 'multi',
        stack: false,        
        series: new Rickshaw.Series.FixedDuration(seriesData,
                undefined, {
                  timeInterval: 1000,
                  maxDataPoints: 100,
                  timeBase: new Date().getTime()
        })
  });

  this.graph_axis_x = new Rickshaw.Graph.Axis.X({
        graph: self.graph,
        orientation: 'bottom',
        element: $x_axis.get(0),
        tickFormat: function(x) {
          var date = new Date(x);
          return date.getMinutes() + ":" + date.getSeconds();
        }    
  });

  this.graph_axis_y = new Rickshaw.Graph.Axis.Y.Scaled( {
        graph: self.graph,
        orientation: 'left',
        element: $y_axis.get(0),
        scale: scale
  } );
  
  this.render = function() {
    self.graph.render();
  };
  
  this.addData = function(data, x) {
    self.graph.series.addData(data, x);
  };
  
  this.identity = 0;
  this.addIdentity = function(time) {
    if(!time) {
      time = new Date().getTime();
    }
    var data = {};
    self.graph.series.forEach(function(s) {
      data[s.name] = self.identity;
    });
    self.addData(data, time);
  };
  
};

var linearscale = d3.scale.linear().nice();
var bytescale = d3.byte.scale();

var palette = new Rickshaw.Color.Palette( { scheme: 'spectrum2001', interpolatedStopCount: 3 } );
var cpu = new GraphMetric($("#cpuMetric"), [
                  { name: 'load', renderer: 'area', color: "#9ED11F" }
                ], "CPU", linearscale);
cpu.graph.configure({min:0, max:100});
cpu.graph_axis_y.tickFormat = function(y) { return y + "%"; };

var ram = new GraphMetric($("#ramMetric"), [
                  { name: 'maxMemory', renderer: 'line', color: "red" },
                  { name: 'freeMemory', renderer: 'line', color: "#263E97"},
                  { name: 'allocatedMemory', renderer: 'area', color: "#9ED11F" }
                ], "RAM", bytescale);
ram.graph_axis_y.tickFormat = function(y) {
  return Rickshaw.Fixtures.Number.formatBase1024KMGTP(y) + "B";
};
  
var packet = new GraphMetric($("#packetMetric"), [
                  { name: 'read', renderer: 'bar', color: "#9ED11F" },
                  { name: 'write', renderer: 'bar', color: "#263E97" }
                ], "Net-Packets", linearscale);
packet.graph.gapSize = 0;

var traffic = new GraphMetric($("#trafficMetric"), [
                  { name: 'read', renderer: 'area', color: "#9ED11F" },
                  { name: 'write', renderer: 'line', color: "#263E97"}
                ], "Traffic", bytescale);
traffic.graph_axis_y.tickFormat = function(y) {
  return Rickshaw.Fixtures.Number.formatBase1024KMGTP(y) + "B";
};



// *********************************************

function metricsAddIdentity() {
  packet.addIdentity();
  traffic.addIdentity();
  cpu.addIdentity();
  ram.addIdentity();
}

function connect() {

  var socket = new WebSocket('ws://localhost:5546/ws');
  socket.onopen = function() {
    $("#socket-status").removeClass("disconnected", false).addClass("connected", false);
    metricsAddIdentity();
    socket.send(JSON.stringify({name:"subscribe", data:{service:"packetMetric"}}));
    socket.send(JSON.stringify({name:"subscribe", data:{service:"trafficMetric"}}));
    socket.send(JSON.stringify({name:"subscribe", data:{service:"cpuMetric"}}));
    socket.send(JSON.stringify({name:"subscribe", data:{service:"ramMetric"}}));
  };
  socket.onmessage = function(evt) {
    var msg = JSON.parse(evt.data);
    
    //console.log(msg.data);
    
    if(msg.name == "packetMetric") {
      packet.addData({read: Math.max(0,msg.data.read), write: Math.max(0,msg.data.write)}, msg.data.timestamp);  
      packet.render();
    } else if(msg.name == "trafficMetric") {  
      traffic.addData({read: msg.data.read, write: msg.data.write}, msg.data.timestamp);  
      traffic.render();
    } else if(msg.name == "cpuMetric") {
      cpu.addData({load: msg.data.load}, msg.data.timestamp);  
      cpu.render();
    } else if(msg.name == "ramMetric") {  
      ram.addData({
          maxMemory: msg.data.maxMemory,
          allocatedMemory: msg.data.allocatedMemory,
          freeMemory: msg.data.allocatedMemory + msg.data.freeMemory
        }, msg.data.timestamp);  
      ram.render();
    }
  };
  socket.onclose = function() {
    $("#socket-status").removeClass("connected", false).addClass("disconnected", false);
    setTimeout(function(){connect()}, 5000);
    metricsAddIdentity();
  }
  
}

cpu.render();
ram.render();
packet.render();
traffic.render();

setTimeout(connect, 200);

</script>


</body>
</html>
